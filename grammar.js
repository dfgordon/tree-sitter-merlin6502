// `script/gammar-src.js` is for human editing
// `grammar.js` is generated by `opcode_processor.py`

// Downstream tools must resolve the following:
// * matching start and end of macro
// * limitations on use of local labels
// * limitations of 6502 and 65C02
// * 8 vs. 16 bit psuedo-opcodes
// * resolving collisions between opcodes, macro calls (macro_calli),
//   and forced long addressing opcode postfixes
// * verify that literal addresses or offsets are valid, e.g., lda -1 is accepted by the parser

// Known differences with legacy Merlin syntax:
// Here semicolons are unconditionally forbidden in labels
// Here square brackets are forbidden in labels, except for start the start of variable token
// dstrings must always be terminated

// Do not set this flag manually, let `build.py` handle it
const allow_lower_case = true;
const language_name = allow_lower_case ? 'merlin6502' : 'merlin6502casesens';
const alphachars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';

// Define constants

const ANYCHAR = /[ !"#$%&'()*+,\-.\/0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ\[\\\]\^_`abcdefghijklmnopqrstuvwxyz{|}~]/;
const NCHAR = /[ !#$%&'()*+,\-.\/0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ\[\\\]\^_`abcdefghijklmnopqrstuvwxyz{|}~]/;
const PCHAR = /[ !"#$%&()*+,\-.\/0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ\[\\\]\^_`abcdefghijklmnopqrstuvwxyz{|}~]/;
const SPCHAR = /[!"#$%&'()*+,\-.\/:;<=>?@\[\\\]\^_`{|}~]/;
const ARG = "!\"#$%&'()*+,-./0123456789:<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~";
const GLOB_LAB_BEG = /[<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ\\\^_`abcdefghijklmnopqrstuvwxyz{|}~]/;
const LAB_CHAR = /[0123456789:<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ\\\^_`abcdefghijklmnopqrstuvwxyz{|}~]/;
const DOS33_CHARS = /[ !"#$%&'()*+\-.\/0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ\[\\\]\^_`abcdefghijklmnopqrstuvwxyz{|}~]{0,29}/;


// Tree-sitter grammar definition

module.exports = grammar({
	name: language_name,
	extras: $ => [],
	conflicts: $ => [
		[$.literal_arg,$.eop_minus],
		[$.literal_arg,$.mode_iopen],
		[$.literal_arg,$.imm_prefix],
		[$.literal_arg,$.current_addr],
		[$.literal_arg,$.eop_plus],
		[$.literal_arg,$.mode_dopen],
		[$.literal_arg,$.decimal],
		[$.literal_arg,$.hexadecimal],
		[$.literal_arg,$.binary]
	],

	rules: {
		source_file: $ => repeat($._factor),
		_factor: $ => choice(
			$.program_counter,
			$.main_comment,
			$.macro_calli,
			$.operation,
			$.pseudo_operation, // excludes macro pseudo-ops
			$._newline
		),
		program_counter: $ => seq($._label,optional(seq($._sep,$.comment)),$._newline), // set label to program counter

		// Macros and labels
		macro_calli: $ => seq(optional($._label),$._sep,$.global_label,optional(seq($._sep,$.macro_args)),optional(seq($._sep,$.comment)),$._newline),

		_newline: $ => seq(optional($._sep),/\r?\n/),
		_sep: $ => /[ \t]+/,
		_arg_sep: $ => choice('.',',','/','-','(',' '), // separates macro call from arguments in the long form, e.g., PMC mymacro,myargs

		_label: $ => choice($.global_label,$.local_label,$.var_label),
		global_label: $ => token(prec.right(seq(GLOB_LAB_BEG,repeat(LAB_CHAR)))), // max 13 (8bit) or 26 (16bit)
		local_label: $ => token(seq(':',repeat1(LAB_CHAR))), // max 13 (8bit) or 26 (16bit),cannot be first label in program,in macro,MAC,ENT,EXT, or EQU
		var_label: $ => token(seq(']',repeat1(LAB_CHAR))),

		macro_args: $ => seq($._arg,repeat(seq(';',$._arg))),
		_arg: $ => choice(
			$._addr_6502,
			$._addr_65816,
			$.literal_arg,
		),
		literal_arg: $ => prec.dynamic(-9,repeat1(choice(...ARG))),

		// Operations

		op_adc: $ => choice('adc','ADC'),
		op_and: $ => choice('and','AND'),
		op_asl: $ => choice('asl','ASL'),
		op_bcc: $ => choice('BLT','blt','bcc','BCC'),
		op_bcs: $ => choice('bcs','BCS','BGE','bge'),
		op_beq: $ => choice('beq','BEQ'),
		op_bit: $ => choice('BIT','bit'),
		op_bmi: $ => choice('BMI','bmi'),
		op_bne: $ => choice('bne','BNE'),
		op_bpl: $ => choice('bpl','BPL'),
		op_bra: $ => choice('BRA','bra'),
		op_brk: $ => choice('BRK','brk'),
		op_bvc: $ => choice('bvc','BVC'),
		op_bvs: $ => choice('bvs','BVS'),
		op_clc: $ => choice('CLC','clc'),
		op_cld: $ => choice('cld','CLD'),
		op_cli: $ => choice('cli','CLI'),
		op_clv: $ => choice('CLV','clv'),
		op_cmp: $ => choice('CMP','cmp'),
		op_cpx: $ => choice('cpx','CPX'),
		op_cpy: $ => choice('CPY','cpy'),
		op_dec: $ => choice('dec','DEC'),
		op_dex: $ => choice('dex','DEX'),
		op_dey: $ => choice('DEY','dey'),
		op_eor: $ => choice('eor','EOR'),
		op_inc: $ => choice('inc','INC'),
		op_inx: $ => choice('inx','INX'),
		op_iny: $ => choice('iny','INY'),
		op_jmp: $ => choice('JMP','jmp'),
		op_jsr: $ => choice('JSR','jsr'),
		op_lda: $ => choice('LDA','lda'),
		op_ldx: $ => choice('LDX','ldx'),
		op_ldy: $ => choice('LDY','ldy'),
		op_lsr: $ => choice('LSR','lsr'),
		op_nop: $ => choice('NOP','nop'),
		op_ora: $ => choice('ORA','ora'),
		op_pha: $ => choice('pha','PHA'),
		op_php: $ => choice('PHP','php'),
		op_phx: $ => choice('phx','PHX'),
		op_phy: $ => choice('phy','PHY'),
		op_pla: $ => choice('PLA','pla'),
		op_plp: $ => choice('plp','PLP'),
		op_plx: $ => choice('PLX','plx'),
		op_ply: $ => choice('ply','PLY'),
		op_rol: $ => choice('ROL','rol'),
		op_ror: $ => choice('ROR','ror'),
		op_rti: $ => choice('rti','RTI'),
		op_rts: $ => choice('rts','RTS'),
		op_sbc: $ => choice('sbc','SBC'),
		op_sec: $ => choice('sec','SEC'),
		op_sed: $ => choice('sed','SED'),
		op_sei: $ => choice('SEI','sei'),
		op_sta: $ => choice('STA','sta'),
		op_stx: $ => choice('STX','stx'),
		op_sty: $ => choice('STY','sty'),
		op_stz: $ => choice('STZ','stz'),
		op_tax: $ => choice('TAX','tax'),
		op_tay: $ => choice('tay','TAY'),
		op_trb: $ => choice('trb','TRB'),
		op_tsb: $ => choice('TSB','tsb'),
		op_tsx: $ => choice('tsx','TSX'),
		op_txa: $ => choice('txa','TXA'),
		op_txs: $ => choice('txs','TXS'),
		op_tya: $ => choice('tya','TYA'),
		op_brl: $ => choice('BRL','brl'),
		op_cop: $ => choice('COP','cop'),
		op_jml: $ => choice('jml','JML'),
		op_jsl: $ => choice('JSL','jsl'),
		op_mvn: $ => choice('MVN','mvn'),
		op_mvp: $ => choice('MVP','mvp'),
		op_pea: $ => choice('PEA','pea'),
		op_pei: $ => choice('PEI','pei'),
		op_per: $ => choice('PER','per'),
		op_phb: $ => choice('PHB','phb'),
		op_phd: $ => choice('PHD','phd'),
		op_phk: $ => choice('phk','PHK'),
		op_plb: $ => choice('plb','PLB'),
		op_pld: $ => choice('PLD','pld'),
		op_rep: $ => choice('REP','rep'),
		op_rtl: $ => choice('RTL','rtl'),
		op_sep: $ => choice('SEP','sep'),
		op_tcd: $ => choice('TCD','tad','TAD','tcd'),
		op_tcs: $ => choice('TAS','TCS','tas','tcs'),
		op_tdc: $ => choice('tdc','tda','TDC','TDA'),
		op_tsc: $ => choice('tsc','TSC','TSA','tsa'),
		op_txy: $ => choice('TXY','txy'),
		op_tyx: $ => choice('tyx','TYX'),
		op_wai: $ => choice('WAI','wai'),
		op_wdm: $ => choice('WDM','wdm'),
		op_xba: $ => choice('SWA','xba','XBA','swa'),
		op_xce: $ => choice('XCE','xce'),
		operation: $ => choice(
			seq(optional($._label), $._sep, $.op_adc, $._sep, choice($.iaddr,$.addr_x,$.addr_y,$.addr_s,$.iaddr_ix,$.addr,$.daddr_y,$.daddr,$.iaddr_is_y,$.iaddr_y,$.imm), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_and, $._sep, choice($.iaddr,$.addr_x,$.addr_y,$.addr_s,$.iaddr_ix,$.addr,$.daddr_y,$.daddr,$.iaddr_is_y,$.iaddr_y,$.imm), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_asl, optional(seq($._sep,choice($.addr_x,$.addr))), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_bcc, $._sep, $.addr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_bcs, $._sep, $.addr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_beq, $._sep, $.addr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_bit, $._sep, choice($.addr_x,$.imm,$.addr), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_bmi, $._sep, $.addr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_bne, $._sep, $.addr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_bpl, $._sep, $.addr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_bra, $._sep, $.addr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_brk, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_bvc, $._sep, $.addr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_bvs, $._sep, $.addr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_clc, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_cld, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_cli, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_clv, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_cmp, $._sep, choice($.iaddr,$.addr_x,$.addr_y,$.addr_s,$.iaddr_ix,$.addr,$.daddr_y,$.daddr,$.iaddr_is_y,$.iaddr_y,$.imm), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_cpx, $._sep, choice($.imm,$.addr), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_cpy, $._sep, choice($.imm,$.addr), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_dec, optional(seq($._sep,choice($.addr_x,$.addr))), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_dex, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_dey, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_eor, $._sep, choice($.iaddr,$.addr_x,$.addr_y,$.addr_s,$.iaddr_ix,$.addr,$.daddr_y,$.daddr,$.iaddr_is_y,$.iaddr_y,$.imm), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_inc, optional(seq($._sep,choice($.addr_x,$.addr))), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_inx, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_iny, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_jmp, $._sep, choice($.iaddr,$.iaddr_ix,$.addr), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_jsr, $._sep, choice($.iaddr_ix,$.addr), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_lda, $._sep, choice($.iaddr,$.addr_x,$.addr_y,$.addr_s,$.iaddr_ix,$.addr,$.daddr_y,$.daddr,$.iaddr_is_y,$.iaddr_y,$.imm), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_ldx, $._sep, choice($.addr_y,$.imm,$.addr), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_ldy, $._sep, choice($.addr_x,$.imm,$.addr), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_lsr, optional(seq($._sep,choice($.addr_x,$.addr))), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_nop, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_ora, $._sep, choice($.iaddr,$.addr_x,$.addr_y,$.addr_s,$.iaddr_ix,$.addr,$.daddr_y,$.daddr,$.iaddr_is_y,$.iaddr_y,$.imm), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_pha, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_php, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_phx, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_phy, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_pla, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_plp, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_plx, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_ply, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_rol, optional(seq($._sep,choice($.addr_x,$.addr))), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_ror, optional(seq($._sep,choice($.addr_x,$.addr))), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_rti, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_rts, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_sbc, $._sep, choice($.iaddr,$.addr_x,$.addr_y,$.addr_s,$.iaddr_ix,$.addr,$.daddr_y,$.daddr,$.iaddr_is_y,$.iaddr_y,$.imm), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_sec, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_sed, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_sei, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_sta, $._sep, choice($.iaddr,$.addr_x,$.addr_y,$.addr_s,$.iaddr_ix,$.addr,$.daddr_y,$.daddr,$.iaddr_is_y,$.iaddr_y), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_stx, $._sep, choice($.addr_y,$.addr), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_sty, $._sep, choice($.addr_x,$.addr), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_stz, $._sep, choice($.addr_x,$.addr), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_tax, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_tay, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_trb, $._sep, $.addr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_tsb, $._sep, $.addr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_tsx, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_txa, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_txs, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_tya, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_brl, $._sep, $.addr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_cop, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_jml, $._sep, $.iaddr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_jsl, $._sep, $.addr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_mvn, $._sep, $.xyc, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_mvp, $._sep, $.xyc, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_pea, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_pei, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_per, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_phb, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_phd, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_phk, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_plb, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_pld, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_rep, $._sep, $.imm, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_rtl, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_sep, $._sep, $.imm, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_tcd, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_tcs, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_tdc, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_tsc, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_txy, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_tyx, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_wai, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_wdm, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_xba, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.op_xce, optional(seq($._sep,$.comment)), $._newline)
		),


		// Pseudo-operations

		psop_equ: $ => choice('equ','=','EQU'),
		psop_ext: $ => choice('EXT','ext'),
		psop_ent: $ => choice('ent','ENT'),
		psop_org: $ => choice('ORG','org'),
		psop_rel: $ => choice('REL','rel'),
		psop_obj: $ => choice('OBJ','obj'),
		psop_put: $ => choice('put','PUT'),
		psop_use: $ => choice('USE','use'),
		psop_var: $ => choice('var','VAR'),
		psop_sav: $ => choice('sav','SAV'),
		psop_typ: $ => choice('TYP','typ'),
		psop_dsk: $ => choice('DSK','dsk'),
		psop_end: $ => choice('END','end'),
		psop_dum: $ => choice('dum','DUM'),
		psop_dend: $ => choice('dend','DEND'),
		psop_ast: $ => choice('AST','ast'),
		psop_cyc: $ => choice('cyc','CYC'),
		psop_dat: $ => choice('DAT','dat'),
		psop_exp: $ => choice('EXP','exp'),
		psop_lst: $ => choice('lst','LST'),
		psop_lstdo: $ => choice('lstdo','LSTDO'),
		psop_pag: $ => choice('PAG','pag'),
		psop_ttl: $ => choice('TTL','ttl'),
		psop_skp: $ => choice('skp','SKP'),
		psop_tr: $ => choice('tr','TR'),
		psop_asc: $ => choice('ASC','asc'),
		psop_dci: $ => choice('DCI','dci'),
		psop_inv: $ => choice('inv','INV'),
		psop_fls: $ => choice('fls','FLS'),
		psop_rev: $ => choice('REV','rev'),
		psop_str: $ => choice('str','STR'),
		psop_da: $ => choice('da','DA','dw','DW'),
		psop_ddb: $ => choice('DDB','ddb'),
		psop_dfb: $ => choice('DFB','db','DB','dfb'),
		psop_adr: $ => choice('ADR','adr'),
		psop_adrl: $ => choice('adrl','ADRL'),
		psop_hex: $ => choice('HEX','hex'),
		psop_ds: $ => choice('DS','ds'),
		psop_do: $ => choice('do','DO'),
		psop_else: $ => choice('else','ELSE'),
		psop_if: $ => choice('if','IF'),
		psop_fin: $ => choice('FIN','fin'),
		psop_chk: $ => choice('CHK','chk'),
		psop_err: $ => choice('ERR','err'),
		psop_kbd: $ => choice('KBD','kbd'),
		psop_lup: $ => choice('LUP','lup'),
		psop_end_lup: $ => '--^',
		psop_mx: $ => choice('MX','mx'),
		psop_pau: $ => choice('pau','PAU'),
		psop_sw: $ => choice('sw','SW'),
		psop_usr: $ => choice('USR','usr'),
		psop_xc: $ => choice('XC','xc'),
		psop_mac: $ => choice('mac','MAC'),
		psop_eom: $ => choice('<<<','EOM','eom'),
		psop_pmc: $ => choice('>>>','pmc','PMC'),
		pseudo_operation: $ => choice(
			seq(optional($._label), $._sep, $.psop_equ, $._sep, $._aexpr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_ext, $._sep, optional(seq($._label,repeat(seq(',',$._label)))), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_ent, $._sep, optional(seq($._label,repeat(seq(',',$._label)))), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_org, $._sep, optional($._aexpr), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_rel, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_obj, $._sep, $._aexpr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_put, $._sep, $.filename, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_use, $._sep, $.filename, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_var, $._sep, $._aexpr,repeat(seq(';',$._aexpr)), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_sav, $._sep, $.filename, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_typ, $._sep, $._aexpr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_dsk, $._sep, $.filename, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_end, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_dum, $._sep, $._aexpr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_dend, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_ast, $._sep, $._aexpr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_cyc, $._sep, optional(choice('OFF','AVE')), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_dat, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_exp, $._sep, choice('ON','OFF','ONLY'), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_lst, $._sep, optional(choice('ON','OFF')), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_lstdo, $._sep, optional('OFF'), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_pag, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_ttl, $._sep, $.dstring, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_skp, $._sep, $._aexpr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_tr, $._sep, optional(choice('ON','OFF')), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_asc, $._sep, $._string_operand, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_dci, $._sep, $._string_operand, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_inv, $._sep, $._string_operand, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_fls, $._sep, $._string_operand, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_rev, $._sep, $.dstring, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_str, $._sep, $._string_operand, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_da, $._sep, $._aexpr,repeat(seq(',',$._aexpr)), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_ddb, $._sep, $._aexpr,repeat(seq(',',$._aexpr)), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_dfb, $._sep, $._eaexpr,repeat(seq(',',$._eaexpr)), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_adr, $._sep, $._aexpr,repeat(seq(',',$._aexpr)), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_adrl, $._sep, $._aexpr,repeat(seq(',',$._aexpr)), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_hex, $._sep, $.hex_data, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_ds, $._sep, choice($._aexpr,seq($._aexpr,',',$._aexpr),'\\',seq('\\',',',$._aexpr)), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_do, $._sep, $._aexpr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_else, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_if, $._sep, ANYCHAR,ANYCHAR,$.var_label, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_fin, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_chk, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_err, $._sep, optional('\\'),$._aexpr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_kbd, $._sep, optional($.dstring), optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_lup, $._sep, $._aexpr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_end_lup, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_mx, $._sep, $._aexpr, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_pau, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_sw, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_usr, $._sep, $.literal, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_xc, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_mac, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_eom, optional(seq($._sep,$.comment)), $._newline),
			seq(optional($._label), $._sep, $.psop_pmc, $._sep, $._label,optional(seq($._arg_sep,$.macro_args)), optional(seq($._sep,$.comment)), $._newline)
		),


		// Strings

		_string_operand: $ => seq($.dstring,optional(seq(',',$.hex_data))),

		// dstring

		dstring: $ => choice(
			seq("!",repeat(ANYCHAR),"!"),
			seq('"',repeat(ANYCHAR),'"'),
			seq("#",repeat(ANYCHAR),"#"),
			seq("$",repeat(ANYCHAR),"$"),
			seq("%",repeat(ANYCHAR),"%"),
			seq("&",repeat(ANYCHAR),"&"),
			seq("'",repeat(ANYCHAR),"'"),
			seq("(",repeat(ANYCHAR),"("),
			seq(")",repeat(ANYCHAR),")"),
			seq("*",repeat(ANYCHAR),"*"),
			seq("+",repeat(ANYCHAR),"+"),
			seq("-",repeat(ANYCHAR),"-"),
			seq(".",repeat(ANYCHAR),"."),
			seq(":",repeat(ANYCHAR),":"),
			seq(";",repeat(ANYCHAR),";"),
			seq("<",repeat(ANYCHAR),"<"),
			seq("=",repeat(ANYCHAR),"="),
			seq(">",repeat(ANYCHAR),">"),
			seq("?",repeat(ANYCHAR),"?"),
			seq("@",repeat(ANYCHAR),"@"),
			seq("A",repeat(ANYCHAR),"A"),
			seq("B",repeat(ANYCHAR),"B"),
			seq("C",repeat(ANYCHAR),"C"),
			seq("D",repeat(ANYCHAR),"D"),
			seq("E",repeat(ANYCHAR),"E"),
			seq("F",repeat(ANYCHAR),"F"),
			seq("G",repeat(ANYCHAR),"G"),
			seq("H",repeat(ANYCHAR),"H"),
			seq("I",repeat(ANYCHAR),"I"),
			seq("J",repeat(ANYCHAR),"J"),
			seq("K",repeat(ANYCHAR),"K"),
			seq("L",repeat(ANYCHAR),"L"),
			seq("M",repeat(ANYCHAR),"M"),
			seq("N",repeat(ANYCHAR),"N"),
			seq("O",repeat(ANYCHAR),"O"),
			seq("P",repeat(ANYCHAR),"P"),
			seq("Q",repeat(ANYCHAR),"Q"),
			seq("R",repeat(ANYCHAR),"R"),
			seq("S",repeat(ANYCHAR),"S"),
			seq("T",repeat(ANYCHAR),"T"),
			seq("U",repeat(ANYCHAR),"U"),
			seq("V",repeat(ANYCHAR),"V"),
			seq("W",repeat(ANYCHAR),"W"),
			seq("X",repeat(ANYCHAR),"X"),
			seq("Y",repeat(ANYCHAR),"Y"),
			seq("Z",repeat(ANYCHAR),"Z"),
			seq("[",repeat(ANYCHAR),"["),
			seq('\\',repeat(ANYCHAR),'\\'),
			seq("]",repeat(ANYCHAR),"]"),
			seq("^",repeat(ANYCHAR),"^"),
			seq("_",repeat(ANYCHAR),"_"),
			seq("`",repeat(ANYCHAR),"`"),
			seq("a",repeat(ANYCHAR),"a"),
			seq("b",repeat(ANYCHAR),"b"),
			seq("c",repeat(ANYCHAR),"c"),
			seq("d",repeat(ANYCHAR),"d"),
			seq("e",repeat(ANYCHAR),"e"),
			seq("f",repeat(ANYCHAR),"f"),
			seq("g",repeat(ANYCHAR),"g"),
			seq("h",repeat(ANYCHAR),"h"),
			seq("i",repeat(ANYCHAR),"i"),
			seq("j",repeat(ANYCHAR),"j"),
			seq("k",repeat(ANYCHAR),"k"),
			seq("l",repeat(ANYCHAR),"l"),
			seq("m",repeat(ANYCHAR),"m"),
			seq("n",repeat(ANYCHAR),"n"),
			seq("o",repeat(ANYCHAR),"o"),
			seq("p",repeat(ANYCHAR),"p"),
			seq("q",repeat(ANYCHAR),"q"),
			seq("r",repeat(ANYCHAR),"r"),
			seq("s",repeat(ANYCHAR),"s"),
			seq("t",repeat(ANYCHAR),"t"),
			seq("u",repeat(ANYCHAR),"u"),
			seq("v",repeat(ANYCHAR),"v"),
			seq("w",repeat(ANYCHAR),"w"),
			seq("x",repeat(ANYCHAR),"x"),
			seq("y",repeat(ANYCHAR),"y"),
			seq("z",repeat(ANYCHAR),"z"),
			seq("{",repeat(ANYCHAR),"{"),
			seq("|",repeat(ANYCHAR),"|"),
			seq("}",repeat(ANYCHAR),"}"),
			seq("~",repeat(ANYCHAR),"~"),
		),


		// 65C02 addressing Modes
	
		_addr_6502: $ => choice($.imm,$.addr,$.addr_x,$.addr_y,$.iaddr_ix,$.iaddr_y,$.iaddr),
		imm: $ => seq($.imm_prefix,$._aexpr),
		addr: $ => $._aexpr,
		addr_x: $ => seq($._aexpr,$.mode_x),
		addr_y: $ => seq($._aexpr,$.mode_y),
		iaddr_ix: $ => seq($.mode_iopen,$._aexpr,$.mode_iix),
		iaddr_y: $ => seq($.mode_iopen,$._aexpr,$.mode_iy),
		iaddr: $ => seq($.mode_iopen,$._aexpr,$.mode_iclose),
		mode_x: $ => allow_lower_case ? choice(',X',',x') : ',X',
		mode_y: $ => allow_lower_case ? choice(',Y',',y') : ',Y',
		mode_iopen: $ => '(',
		mode_iclose: $ => ')',
		mode_iix: $ => allow_lower_case ? choice(',X)',',x)') : ',X)',
		mode_iy: $ => allow_lower_case ? choice('),Y','),y') : '),Y',

		// 65C816 addressing modes

		_addr_65816: $ => choice($.daddr,$.daddr_y,$.addr_s,$.iaddr_is_y,$.xyc),
		daddr: $ => seq($.mode_dopen,$._aexpr,$.mode_dclose),
		daddr_y: $ => seq($.mode_dopen,$._aexpr,$.mode_dy),
		addr_s: $ => seq($._aexpr,$.mode_s),
		iaddr_is_y: $ => seq($.mode_iopen,$._aexpr,$.mode_is_y),
		xyc: $ => seq($._aexpr,',',$._aexpr),
		mode_dopen: $ => '[',
		mode_dclose: $ => ']',
		mode_dy: $ => allow_lower_case ? choice('],Y','],y') : '],Y',
		mode_s: $ => allow_lower_case ? choice(',S',',s') : ',S',
		mode_is_y: $ => allow_lower_case ? choice(',S),Y',',s),y') : ',S),Y',


		// Expressions

		_eaexpr: $ => seq(optional($.imm_prefix),$._aexpr),
		_aexpr: $ => choice(
			$._label,
			$.number,
			$.pchar,
			$.nchar,
			$.current_addr,
			$.unary_aexpr,
			$.binary_aexpr
		),
		unary_aexpr: $ => prec(1,choice(seq($.eop_plus,$._aexpr),seq($.eop_minus,$._aexpr))),
		// MERLIN has no operator precedence: left to right always prevails
		binary_aexpr: $ => prec.left(seq($._aexpr,choice(
			$.eop_plus,$.eop_minus,$.eop_times,$.eop_div,$.eop_or,$.eop_and,$.eop_xor
		),$._aexpr)),

		eop_plus: $ => '+',
		eop_minus: $ => '-',
		eop_times: $ => '*',
		eop_div: $ => '/',
		eop_or: $ => '.',
		eop_and: $ => '&',
		eop_xor: $ => '!',

		// Primitive Expressions

		imm_prefix: $ => choice('#','#<','#>','#^'),
		hex_byte: $ => /[0-9A-Fa-f][0-9A-Fa-f]/,
		hex_data: $ => seq($.hex_byte,repeat(seq(optional(','),$.hex_byte))),
		filename: $ => choice($.prodos,$.dos33),
		prodos: $ => seq(choice(...alphachars),/[A-Za-z0-9.]{0,14}/),
		dos33: $ => seq(choice(...alphachars),DOS33_CHARS),

		number: $ => choice($.decimal,$.hexadecimal,$.binary),
		decimal: $ => repeat1(choice(...'0123456789')),
		hexadecimal: $ => seq('$',repeat1(choice(...'0123456789ABCDEFabcdef'))),
		binary: $ => seq('%',repeat1(choice(...'01'))),

		pchar: $ => seq("'",PCHAR,optional("'")),
		nchar: $ => seq('"',NCHAR,optional('"')),

		current_addr: $ => '*',

		literal: $ => /.*/,

		// Comments

		comment: $ => seq(';',$.comment_text), // max 64 - len(operand)
		comment_text: $ => /.*/,
		main_comment: $ => seq(/\s*\*.*/,$._newline) // max 64
	}
});
